# ìŠ¤í„°ë”” í´ëŸ½ WEB-RTC
<img src="https://gtypeid.github.io/resource/path/folio/logo-1.png" width="300" alt="í”„ë¡œì íŠ¸ ë¡œê³ ">

## ğŸ“ í”„ë¡œì íŠ¸ ê°œìš”
Webì—ì„œ N:N ë‹¤ìˆ˜ì˜ ì‚¬ìš©ìë“¤ê³¼ í™”ìƒ í†µí™”ë¥¼ ì§„í–‰í•˜ê±°ë‚˜,
ì—°ê²°ëœ P2P ë°ì´í„° ì±„ë„ì„ í†µí•´ ë°ì´í„°ë¥¼ êµí™˜í•˜ì—¬ ì±„íŒ… ë° ê³µìš© ë³´ë“œì˜ ë‚™ì„œë‚˜ ì‚¬ì§„ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.
WebRTC ì—°ê²° ê³¼ì •ì„ NodeJs, Socketì´ ì•„ë‹Œ Http ë©”ì‹œì§€ë¡œ í•¸ë“¤ë§í•˜ê³  ì‹¶ì—ˆìœ¼ë©°,
ì´ë²¤íŠ¸ ì§€í–¥ì„±ìœ¼ë¡œ í™•ì¥ì„±ì„ ê³ ë ¤í•˜ì—¬ ì‹œê·¸ë„ë§ ì„œë²„ ë° í´ë¼ì´ì–¸ë¥¼ ë§¡ì•˜ìŠµë‹ˆë‹¤.


## ğŸ§© í”„ë¡œì íŠ¸ ì˜ë„ ë° ì´ì 
### ìŠ¤í„°ë”” í´ëŸ½ WEB-RTC
- Web RTCë¥¼ ì•Œê²Œ ë˜ì–´ í¥ë¯¸ë¡œìš´ ê¸°ìˆ ì´ë¼ê³  ìƒê°í•˜ê³ , N:N ì—°ê²°ì„ ì‹œë„í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
- NodeJS ë° WebSocketì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , HTTP ë©”ì‹œì§€ í•¸ë“¤ë§ë§Œìœ¼ë¡œ ì—°ê²°ì„ ì‹œë„í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
- ë¦¬ì•¡í‹°ë¸Œ í”„ë¡œê·¸ë˜ë° ì´ë²¤íŠ¸ êµ¬ë… ë°œí–‰ ëª¨ë¸ì„ ëª¨ë°©í•˜ì—¬, ë©”ì‹œì§€ íì™€ ì´ë²¤íŠ¸ë¥¼ í™œìš©í•œ í™•ì¥ì„± ìˆëŠ” êµ¬ì¡°ë¥¼ ì˜ë„í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
- ì†ì‰¬ìš´ ë°© ìƒì„±, ë°© ì…ì¥ APIë¥¼ í†µí•´ í”„ë¡œì íŠ¸ì— ì† ì‰½ê²Œ ë¶€ì°©í•˜ì˜€ìŠµë‹ˆë‹¤.

## ğŸ› ï¸ ì‚¬ìš© ê¸°ìˆ 
- ê¸°ìˆ 
  - JAVA
  - JAVASCRIPT
  - SPRING
- ë¼ì´ë¸ŒëŸ¬ë¦¬
  - WEB RTC
  
## ğŸ” í”„ë¡œì íŠ¸ ì‚´í´ë³´ê¸°
### RTC ì‹œì—°
<img src="https://gtypeid.github.io/resource/path/folio/rtc-1.gif" width="700" alt="í”„ë¡œì íŠ¸ ë¡œê³ "><br><br>
- WebRTC ë‘ í´ë¼ì´ì–¸íŠ¸ì˜ P2Pì—°ê²° í›„ í™”ë©´ì…ë‹ˆë‹¤.
ë°ì´í„° ì±„ë„ì„ í†µí•´ ì±„íŒ… ë°
ìº”ë²„ìŠ¤ ë©”íƒ€ ë°ì´í„°ë¥¼ ì „ë‹¬ ë°›ìœ¼ë©°
ë“œë¡œì‰ ì„  & ì»¤ì„œ & ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.
<br><br>

<img src="https://gtypeid.github.io/resource/path/folio/rtc-0.gif" width="700" alt="í”„ë¡œì íŠ¸ ë¡œê³ "><br><br>
- N:N ë‹¤ìˆ˜ì˜ WebRTC ì—°ê²° ëª¨ìŠµì…ë‹ˆë‹¤.
<br><br>

## ğŸ“‹ êµ¬í˜„ ê¸°ëŠ¥ 
- ì‹œê·¸ë„ë§ ì„œë²„
  - ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ë“±ë¡ API : SSE Event (Server Sent Event), ì´ë²¤íŠ¸ í•¸ë“¤ API
  - ë°© ìƒì„± API & ë°© ì…ì¥ API
  - ë°© ì¡°íšŒ API & ë‹¤ìˆ˜ ë°© ì¡°íšŒ API
- í´ë¼ì´ì–¸íŠ¸
  - Web RTC N:N ì—°ê²° ë° ì—°ê²° í›„ P2P ë°ì´í„° ì±„ë„ì„ í†µí•œ
  - í™”ìƒ ì—°ê²° & ì±„íŒ…
- ìº”ë²„ìŠ¤ ë™ê¸°í™” : ì„  ê·¸ë¦¬ê¸°, ì„  ìƒ‰ ë³€ê²½, í™”ë©´ ì»¤ì„œ, í™”ë©´ ì§€ìš°ê¸°, ì‚¬ì§„ ê°ì²´
  - ë°± ë²„í¼ ìº”ë²„ìŠ¤
- ë°© ë²„ì „ ì²´í¬
- ì´ë²¤íŠ¸ íŒŒì´í”„ë¼ì¸
  
## ğŸ“ WEB RTC SERVER ë‹¤ì´ì–´ê·¸ë¨
### WEB RTC í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°
- ë°œì‹ ìê°€ Offer ìƒì„± ë° ë¡œì»¬ ì •ë³´ ì„¤ì • ì‹œ ë°œì‹ ìì˜ ë„¤íŠ¸ì›Œí¬ í›„ë³´ë“¤ì´ SDPì¸ì¦ì„œì— ë“±ë¡ë©ë‹ˆë‹¤.
- ìˆ˜ì‹ ìëŠ” ë°œì‹ ìì˜ Offerë¥¼ ìˆ˜ì‹ í•˜ê³ , ì›ê²© ì •ë³´ ì„¤ì • ì´í›„ Offerê¸°ë°˜ Answerì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
- ì´í›„ ìˆ˜ì‹ ìëŠ” ë§ˆì°¬ê°€ì§€ë¡œ ë¡œì»¬ ì •ë³´ ì„¤ì • ì‹œ ìˆ˜ì‹ ìì˜ ë„¤íŠ¸ì›Œí¬ í›„ë³´ë“¤ì´ SDPì¸ì¦ì„œì— ë“±ë¡ë˜ë©°,
- ì´í•˜ ë°œì‹ ìê°€ SDP ì¸ì¦ì„œê°€ ë‹´ê¸´ Answerë¥¼ ì‘ë‹µë°›ê³  ì›ê²© ì •ë³´ ì„¤ì • ì‹œ,
- ë‘˜ì€ Connected ìƒíƒœë¡œ ì „í™˜ ë˜ë©°, P2P ì—°ê²° ìƒíƒœê°€ ë©ë‹ˆë‹¤.

```mermaid
flowchart LR
A[ë°œì‹ ì] -->|"Offer
LocalDescription,
Icecandidate (SDP)"| B[ìˆ˜ì‹ ì]

B[ìˆ˜ì‹ ì] --> |"RemoteDescription,
Answer,
LocalDescription,
Icecandidate (SDP)"| C[ë°œì‹ ì]

C[ë°œì‹ ì] --> |"RemoteDescription"| D[ì—°ê²°]
```

### íë¦„ë„ (ì„œë²„)
<img src="https://gtypeid.github.io/resource/path/folio/rtc-server-flow-0.png" width="600" alt="í”„ë¡œì íŠ¸ ë¡œê³ ">
<img src="https://gtypeid.github.io/resource/path/folio/rtc-server-flow-1.png" width="600" alt="í”„ë¡œì íŠ¸ ë¡œê³ ">
<img src="https://gtypeid.github.io/resource/path/folio/rtc-server-flow-2.png" width="600" alt="í”„ë¡œì íŠ¸ ë¡œê³ ">

#### SSEService
- SSEControllerë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì— SSEEvent ìŠ¤íŠ¸ë¦¼ì„ ë“±ë¡í•©ë‹ˆë‹¤.
EventCaptureë¥¼ í†µí•œ ê²°ê³¼ë¥¼ ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
  - autowire
  - EventCapture êµ¬í˜„ì²´ë“¤ì„ ì˜ì¡´ ì£¼ì…í•©ë‹ˆë‹¤.
  - OfferEventêµ¬í˜„ì²´ëŠ” Offer, AnswerEventêµ¬í˜„ì²´ëŠ” Answer.
    ì´ë²¤íŠ¸ì™€ ë§¤ì¹­ ë©ë‹ˆë‹¤. ì‚¬ìš©ìì— ì˜ê±° EventCapture í´ë˜ìŠ¤ê°€ í™•ì¥ ë˜ì–´ë„,
    ê¸°ì¡´ ì½”ë“œë¥¼ ìˆ˜ì • í•˜ì§€ ì•Šë„ë¡ Spring ì˜ì¡´ ì£¼ì…ì„ í™œìš©í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
     ```java
      @Service
      public class SSEService {
      
          private Map< String, Map< String, SseEmitter > > roomClientEmitters 
              = new ConcurrentHashMap<>();
          private Map< String, EventCapture > eventCaptureStore 
              = new ConcurrentHashMap<>();
      
          @Autowired
          SSEService(List< EventCapture > eventCaptures){
              eventCaptures.forEach(ec -> eventCaptureStore.put(getEventType(ec), ec));
          }
      
          private String getEventType(EventCapture eventCapture){
              String simpleName = eventCapture.getClass().getSimpleName().toLowerCase();
              int index = simpleName.indexOf("event");
              return simpleName.substring(0, index);
          }
      }

     @Component
      public class OfferEvent implements EventCapture{
          .
          .
          .
      }
    
      @Component
      public class AnswerEvent implements EventCapture{
          .
          .
          .
      }
     ```
  - publish
  - í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ìš”ì²­ë°›ì€ HandleEventë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.
    í´ë¼ì´ì–¸íŠ¸ë“¤ì„ ìˆœíšŒ í•˜ë©°, EventCaptureê°€ ì í•©í•œ Eventë¥¼ ì²˜ë¦¬í•˜ì—¬,
    í´ë¼ì´ì–¸íŠ¸ë“¤ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.
  - ì±…ì„ ë° ì²˜ë¦¬ë¥¼ EventCaptureë¡œ ìœ„ì„ì‹œì¼œ,
    ì´ë²¤íŠ¸ í™•ì¥ì—ë„ ì½”ë“œ ìˆ˜ì •ì´ ì—†ë„ë¡ ë””ìì¸í•´ë³´ì•˜ìŠµë‹ˆë‹¤.
     ```java
      public void publish(HandleEvent handleEvent){
        .
        .
        Map clients = roomClientEmitters.get(roomUuid);
        clients.forEach( (targetClient, emitter) ->{
            doPublish(targetClient, handleEvent, emitter, clients);
        });
    }

    private void doPublish(String targetClient, HandleEvent handleEvent, 
        SseEmitter emitter, Map< String, SseEmitter > clients){

        String eventType = handleEvent.getEventType();

        if( eventCaptureStore.containsKey(eventType) ){
            EventCapture eventCapture = eventCaptureStore.get(eventType);
            eventCapture.doAction(targetClient, handleEvent, (data) ->{
                try {
                    emitter.send(data, MediaType.APPLICATION_JSON);
                } catch (IOException e) {
                    .
                    .
                }
            });
        }
    }
     ```
#### EventCapture
  - Eventë¥¼ ì í•©í•˜ê²Œ ì²˜ë¦¬í•  ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
  ì í•© êµ¬í˜„ì²´ê°€ ê·¸ ì—­í• ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
    - JoinEvent
    - EventCapture êµ¬í˜„í•œ JoinEventì…ë‹ˆë‹¤.
      Join ë°œìƒ ì‹œ ìš”ì²­ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì œì™¸í•œ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë°œì†¡í•©ë‹ˆë‹¤.
       ```java
        @Component
        public class JoinEvent implements EventCapture{
        
            private final RoomService roomService;
        
            @Autowired
            public JoinEvent(RoomService roomService){
                this.roomService = roomService;
            }
        
            @Override
            public void doAction(String targetClient, HandleEvent handleEvent, 
                Consumer< RoomStateEventHandler > consumer) {
        
                if(!targetClient.equals(handleEvent.getClientUuid())){
  
                    HandleEvent data = new HandleEvent(handleEvent);
                    Room room = 
                        roomService.getRoomStore().get( handleEvent.getRoomUuid() );
        
                    RoomStateEventHandler roomStateEventHandler = 
                        new RoomStateEventHandler(room, data);
                    consumer.accept(roomStateEventHandler);
                }
            }
        }
       ```
## ğŸ“ WEB RTC CLINET ë‹¤ì´ì–´ê·¸ë¨
### í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°
- ì„œë²„ë¡œë¶€í„° Eventë¥¼ ë°›ìœ¼ë©´ BeatSyncë¥¼ í†µí•´ ë°©ì— ëŒ€í•œ ì •ë³´ ë° ë²„ì „ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
- í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ MsgQueue Pipeì— ë°œí–‰í•©ë‹ˆë‹¤.
- PipeëŠ” PipeChainìœ¼ë¡œ ë¶€í„° ì§„ì… ì‹œ í•„í„°ë¥¼ ê±°ì¹˜ê³  ë°œí–‰ ì‹œ íŠ¹ì • ë¡œì§ì„ ì²˜ë¦¬í•˜ë©°,
- ì²˜ë¦¬ ê²°ê³¼ê°€ ì‹œê·¸ë„ë§ ì„œë²„ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
